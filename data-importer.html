<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grace Irvine - 数据导入工具</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .step {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }
        .step h3 {
            color: #2196F3;
            margin-top: 0;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        textarea {
            height: 150px;
            resize: vertical;
        }
        button {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #1976D2;
        }
        .instructions {
            background: #e8f5e8;
            padding: 15px;
            border-left: 4px solid #4CAF50;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Grace Irvine 教会 - 数据导入工具</h1>
        
        <div class="step">
            <h3>步骤 1: 从Google Sheets导出数据</h3>
            <div class="instructions">
                <strong>操作说明：</strong>
                <ol>
                    <li>打开您的Google Sheets: <a href="https://docs.google.com/spreadsheets/d/1wescUQe9rIVLNcKdqmSLpzlAw9BGXMZmkFvjEF296nM/edit?gid=0#gid=0" target="_blank">点击这里</a></li>
                    <li>选择所有数据 (Ctrl+A 或 Cmd+A)</li>
                    <li>复制数据 (Ctrl+C 或 Cmd+C)</li>
                    <li>将数据粘贴到下方的文本框中</li>
                </ol>
                <p><strong>注意：</strong>确保包含媒体部相关列(Q、R、S、T、U等)的数据，系统会自动分析音控、导播、ProPresenter等服侍岗位。</p>
            </div>
            
            <div class="input-group">
                <label for="csvData">粘贴Google Sheets数据:</label>
                <textarea id="csvData" placeholder="在此粘贴您从Google Sheets复制的数据..."></textarea>
            </div>
            
            <button onclick="processGoogleSheetsData()">处理数据</button>
        </div>
        
        <div class="step">
            <h3>步骤 2: 或直接输入Google Sheets URL</h3>
            <div class="warning">
                <strong>注意：</strong>Google Sheets必须设置为"任何拥有链接的人都可以查看"才能直接读取。
            </div>
            
            <div class="input-group">
                <label for="sheetsUrl">Google Sheets URL:</label>
                <input type="url" id="sheetsUrl" value="https://docs.google.com/spreadsheets/d/1wescUQe9rIVLNcKdqmSLpzlAw9BGXMZmkFvjEF296nM/edit?gid=0#gid=0" placeholder="https://docs.google.com/spreadsheets/d/...">
            </div>
            
            <button onclick="loadFromGoogleSheets()">从URL载入数据</button>
        </div>
        
        <div class="step">
            <h3>步骤 3: 预览和生成可视化</h3>
            <div id="dataPreview" style="display: none;">
                <h4>数据预览:</h4>
                <div id="previewContent"></div>
                <button onclick="generateVisualization()" style="margin-top: 15px;">生成可视化图表</button>
            </div>
        </div>
    </div>

    <script>
        let processedData = null;

        function processGoogleSheetsData() {
            const csvData = document.getElementById('csvData').value.trim();
            if (!csvData) {
                alert('请先粘贴Google Sheets数据');
                return;
            }

            try {
                // 简单的CSV解析
                const lines = csvData.split('\n').filter(line => line.trim());
                const headers = lines[0].split('\t');
                
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split('\t');
                    if (values.length >= headers.length) {
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header.trim()] = values[index] ? values[index].trim() : '';
                        });
                        data.push(row);
                    }
                }

                processedData = data;
                showDataPreview(data);
            } catch (error) {
                alert('数据处理失败，请检查数据格式: ' + error.message);
            }
        }

        function loadFromGoogleSheets() {
            const url = document.getElementById('sheetsUrl').value.trim();
            if (!url) {
                alert('请输入Google Sheets URL');
                return;
            }

            // 提取Sheet ID并构建CSV导出URL
            const sheetIdMatch = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
            if (!sheetIdMatch) {
                alert('无效的Google Sheets URL');
                return;
            }

            const sheetId = sheetIdMatch[1];
            const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=0`;
            
            alert('由于浏览器安全限制，请手动导出数据：\n\n1. 打开Google Sheets\n2. 文件 → 下载 → 逗号分隔值(.csv)\n3. 打开下载的CSV文件\n4. 复制所有内容到上方文本框');
        }

        function showDataPreview(data) {
            const preview = document.getElementById('dataPreview');
            const content = document.getElementById('previewContent');
            
            let html = `<p><strong>共找到 ${data.length} 条记录</strong></p>`;
            html += '<table border="1" style="width: 100%; border-collapse: collapse;">';
            
            if (data.length > 0) {
                // 表头
                html += '<tr>';
                Object.keys(data[0]).forEach(key => {
                    html += `<th style="padding: 8px; background: #f0f0f0;">${key}</th>`;
                });
                html += '</tr>';
                
                // 显示前3行数据
                for (let i = 0; i < Math.min(3, data.length); i++) {
                    html += '<tr>';
                    Object.values(data[i]).forEach(value => {
                        html += `<td style="padding: 8px;">${value}</td>`;
                    });
                    html += '</tr>';
                }
                
                if (data.length > 3) {
                    html += `<tr><td colspan="${Object.keys(data[0]).length}" style="text-align: center; padding: 8px; font-style: italic;">... 还有 ${data.length - 3} 行数据</td></tr>`;
                }
            }
            
            html += '</table>';
            content.innerHTML = html;
            preview.style.display = 'block';
        }

        function generateVisualization() {
            if (!processedData) {
                alert('请先处理数据');
                return;
            }

            // 将数据存储到localStorage
            localStorage.setItem('ministryData', JSON.stringify(processedData));
            
            // 跳转到可视化页面
            window.open('index.html', '_blank');
        }
    </script>
</body>
</html>