# 新增功能：互动数据可视化

## 🎯 功能概述

新增了高效的互动数据可视化功能，专门用于分析同工事工统计，回答关键问题：
- **最近4周哪个同工事工最多？**
- **最近一季度哪个同工事工最多？**
- **同工参与趋势如何变化？**

## 🚀 主要功能

### 1. 同工排行榜 (新标签页)
- **数据洞察卡片**: 显示4周和季度冠军、活跃同工统计
- **互动排行榜图表**: 
  - 🥇🥈🥉 前三名特殊颜色标识
  - 悬停显示详细信息（事工次数、服务类型）
  - Top 15 同工展示
- **排行榜表格**: 详细的前10名列表，包含徽章显示
- **4周 vs 季度对比**: 并排条形图对比同工在不同时期的表现

### 2. 互动分析 (新标签页)
提供三种深度分析模式：

#### 📈 每周趋势分析
- 双轴线图显示总事工次数和参与人数趋势
- 可调节分析周数 (4-24周)
- 详细数据表格展开查看

#### 🎯 服务类型分布
- 互动饼图显示各服务类型占比
- 统计卡片显示具体数字和参与人数
- 实时百分比计算

#### 🔥 同工活跃度热力图
- 热力图矩阵显示同工×周期活跃度
- 颜色深度表示事工频率
- Top 20 最活跃同工展示

## 🛠 技术实现

### 新增模块
1. **`app/visualizations.py`**: 高级可视化组件库
2. **存储层增强**: `storage/duckdb_store.py` 新增4个查询函数
3. **聚合层增强**: `metrics/aggregations.py` 新增4个聚合函数

### 新增数据库查询
```sql
-- 最近N周同工统计
query_volunteer_stats_recent_weeks(weeks)

-- 最近一季度同工统计  
query_volunteer_stats_recent_quarter()



-- 服务类型分布
query_service_type_distribution_recent(weeks)
```

### 可视化技术栈
- **Plotly**: 高性能互动图表
- **Streamlit**: 原生UI组件集成
- **Pandas**: 数据处理和聚合

## 🎨 用户界面特性

### 视觉设计
- **金银铜配色**: 前三名使用特殊颜色 (#FFD700, #C0C0C0, #CD7F32)
- **响应式布局**: 自适应屏幕大小
- **悬停交互**: 丰富的工具提示信息
- **图标标识**: 使用emoji增强视觉效果

### 交互功能
- **动态筛选**: 可调节时间范围
- **多种视图**: 图表+表格双重展示
- **数据下载**: 支持CSV导出
- **实时更新**: 与数据刷新联动

## 📊 数据洞察

### 关键指标
- **冠军同工**: 4周和季度表现最佳者
- **活跃度统计**: 参与人数和平均事工次数
- **趋势分析**: 周度变化趋势
- **类型分布**: 各服务类型参与情况

### 智能对比
- **时间对比**: 4周 vs 一季度表现
- **同工对比**: 并排显示不同同工数据
- **类型对比**: 服务类型参与度对比

## 🚀 使用方法

1. **启动应用**: `streamlit run run_app.py`
2. **数据刷新**: 点击侧边栏"手动刷新"按钮
3. **查看排行榜**: 切换到"同工排行榜"标签页
4. **深度分析**: 切换到"互动分析"标签页
5. **调整参数**: 使用滑块和选择框自定义分析

## 🔧 配置说明

新功能自动继承现有配置：
- 服务类型过滤: `configs/config.yaml` 中的 `include_service_types`
- 时区设置: 自动处理时间转换
- 数据库路径: 使用现有DuckDB配置

## 📈 性能优化

- **查询优化**: 使用SQL聚合减少数据传输
- **缓存机制**: Streamlit原生缓存
- **分页显示**: 限制Top N显示数量
- **异步加载**: 并行数据查询

## 🎯 未来扩展

可考虑的增强功能：
- 预测分析：基于历史数据预测未来趋势
- 自动报告：定期生成同工表现报告
- 移动端优化：响应式设计进一步优化
- 导出功能：支持PDF/Excel格式导出
